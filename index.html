<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="logo.png">
    <title>Penjualan</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    
    <div class="app">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="logo">
                <img src="logo.jpg" alt="Logo">
                <h2>Warehouse</h2>
            </div>

            <nav>
                <a href="index.html" class="active">Penjualan</a>
                <a href="penjualan.html">Audit Stok</a>
                <a href="persediaan.html">Persediaan</a>
                <a href="forecasting.html">Forecasting</a>
            </nav>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="content">
            <!-- LOADING -->
<div id="loading">
  <img src="logo.jpg" alt="Loading">
  <p>Memuat data...</p>
</div>
            <header>
                <h1>Penjualan</h1>
                <p>Ringkasan persediaan & transaksi</p>
                <div class="filter-bar">
                    
  <div class="filter-bar">

  <!-- SEARCHABLE DROPDOWN PRODUK -->
  <div class="custom-select">
    <input 
      type="text" 
      id="searchStock" 
      placeholder="Cari produk..."
      autocomplete="off"
    >
    <div id="produkDropdown" class="dropdown-list"></div>
  </div>

  <!-- FILTER BULAN -->
  <select id="filterBulan">
    <option value="">Semua Bulan</option>
    <option value="1">Januari</option>
    <option value="2">Februari</option>
    <option value="3">Maret</option>
    <option value="4">April</option>
    <option value="5">Mei</option>
    <option value="6">Juni</option>
    <option value="7">Juli</option>
    <option value="8">Agustus</option>
    <option value="9">September</option>
    <option value="10">Oktober</option>
    <option value="11">November</option>
    <option value="12">Desember</option>
  </select>

</div>
            </header>

            <section class="cards">

<div class="card">
    <h3>Total Produk Terjual</h3>
    <span id="totalProdukTerjual">0</span>
    <small>Jumlah produk unik yang memiliki transaksi</small>
</div>

<div class="card">
    <h3>Total Produk Aktif</h3>
    <span id="totalProduk">0</span>
    <small>Total seluruh produk yang tersedia</small>
</div>

<div class="card">
    <h3>Produk Belum Terjual</h3>
    <span id="produkBelumTerjual">0</span>
    <small>Produk yang belum ada transaksi</small>
</div>

<div class="card">
    <h3>Total Stok</h3>
    <span id="totalStok">0</span>
</div>

<div class="card">
    <h3>Total Penjualan (Qty)</h3>
    <span id="totalPenjualan">0</span>
</div>

<div class="card">
  <h3>Total Penjualan (Rp)</h3>
  <span id="totalPenjualanRp">0</span>
</div>

<div class="card">
  <h3>Total Outlet Keseluruhan</h3>
  <span id="totalOutletAll">0</span>
</div>

<div class="card">
  <h3>Outlet Transaksi</h3>
  <span id="kpiOutletAktif">0</span>
</div>

<div class="card">
  <h3>Outlet Tidak Transaksi</h3>
  <span id="kpiOutletNonAktif">0</span>
</div>

</section>

<section class="chart-row">

<div class="chart-box">
  <h3>Kontribusi Produk (Tinggi â†’ Rendah)</h3>
  <canvas id="produkChart" height="320"></canvas>
</div>

<div class="chart-box">
  <h3>Grafik Penjualan per Bulan</h3>
  <canvas id="penjualanChart" height="320"></canvas>
</div>

</section>
<section class="chart-box">
  <h3>Kontribusi Outlet (Terbanyak & Terendah)</h3>
  <canvas id="outletChart" height="320"></canvas>
</section>

<section class="status-row">

 <div class="status-box produk-box">
  <div class="status-header">
    <h3>Status Produk</h3>
    <button id="exportProdukCSV" class="btn-export">Export CSV</button>
  </div>
  <div id="listProdukStatus"></div>
</div>

  <div class="status-box outlet-box">
  <div class="status-header">
    <h3>Status Outlet</h3>
    <button id="exportOutletCSV" class="btn-export">Export CSV</button>
  </div>

  <select id="filterStatusOutlet">
    <option value="">Semua</option>
    <option value="aktif">Sudah Transaksi</option>
    <option value="nonaktif">Belum Transaksi</option>
  </select>

  <div id="listOutletStatus"></div>
</div>

</section>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

 <script>
/* ======================= KONFIGURASI ======================= */
const API_URL = "https://script.google.com/macros/s/AKfycbzY3q9H0Rh-j4xq3rQmfyNiQBTRS_nECuWwouBEeNXMCDQwYHtBAj6Sic9KQ6P5aW7x/exec";

/* ======================= ELEMENT ======================= */
const filterProduk = document.getElementById("filterProduk");
const filterBulan = document.getElementById("filterBulan");
const loading = document.getElementById("loading");

const totalProdukEl = document.getElementById("totalProduk");
const totalStokEl = document.getElementById("totalStok");
const totalPenjualanEl = document.getElementById("totalPenjualan");
const totalPenjualanRpEl = document.getElementById("totalPenjualanRp");
const kpiOutletAktifEl = document.getElementById("kpiOutletAktif");
const kpiOutletNonAktifEl = document.getElementById("kpiOutletNonAktif");
const filterStatusOutlet = document.getElementById("filterStatusOutlet");
const listOutletStatus = document.getElementById("listOutletStatus");
const totalProdukTerjualEl = document.getElementById("totalProdukTerjual");
const produkBelumTerjualEl = document.getElementById("produkBelumTerjual");
const totalOutletAllEl = document.getElementById("totalOutletAll");
const listProdukStatus = document.getElementById("listProdukStatus");
const exportProdukBtn = document.getElementById("exportProdukCSV");
const exportOutletBtn = document.getElementById("exportOutletCSV");

/* ======================= STATE ======================= */
let penjualanRaw = [];
let persediaan = [];
let hargaMap = {};
let chart = null;
let masterOutlet = [];
let produkChart = null;
let outletChart = null;

/* ======================= LOADING ======================= */
function showLoading(){
  loading.style.display="flex";
}
function hideLoading(){
  loading.style.display="none";
}

/* ======================= FETCH ======================= */
showLoading();

fetch(API_URL)
.then(res=>res.json())
.then(data=>{

  penjualanRaw = (data.penjualan||[]).slice(1);
  persediaan = (data.persediaan||[]).slice(1);
  masterOutlet = (data.masterOutlet||[]).slice(1);

  const masterHarga = (data.masterHarga||[]).slice(1);
  masterHarga.forEach(r=>{
    const sku=r[0];
    const harga=Number(r[3])||0;
    if(sku) hargaMap[sku]=harga;
  });

  initFilterBulan();
  isiDropdownProduk();
  buildChartOnce();
  updateKPI();

  hideLoading();
});

/* ======================= INIT ======================= */
function initFilterBulan(){
  filterBulan.value=new Date().getUTCMonth()+1;
}

function isiDropdownProduk(){
  const setProduk=new Set();
  penjualanRaw.forEach(r=>{
    if(r[3]) setProduk.add(r[3].toString().trim().toUpperCase());
  });

  [...setProduk].sort().forEach(p=>{
    const opt=document.createElement("option");
    opt.value=p;
    opt.textContent=p;
    filterProduk.appendChild(opt);
  });
}

/* ======================= KPI ======================= */
function updateKPI(){

  const produkDipilih = filterProduk.value ? filterProduk.value.toUpperCase() : "";
  const bulanDipilih = filterBulan.value;

  const semuaProdukSet=new Set();
  const produkTerjualSet=new Set();
  const allOutlet=new Set();
  const outletTransaksi=new Set();

  let totalQty=0;
  let totalRp=0;
  let totalStok=0;

  /* ===== MASTER PRODUK ===== */
  persediaan.forEach(r=>{
    const produk=r[1] ? r[1].toString().trim().toUpperCase() : "";
    const stok=Number(r[5])||0;

    if(produk) semuaProdukSet.add(produk);

    if(!produkDipilih || produk===produkDipilih){
      totalStok+=stok;
    }
  });

  /* ===== MASTER OUTLET ===== */
  masterOutlet.forEach(r=>{
    const outlet=r[1] ? r[1].toString().trim().toUpperCase() : "";
    if(outlet) allOutlet.add(outlet);
  });

  /* ===== PENJUALAN ===== */
  penjualanRaw.forEach(r=>{
    const bulanUTC=new Date(r[0]).getUTCMonth()+1;
    const outlet=r[2] ? r[2].toString().trim().toUpperCase() : "";
    const produk=r[3] ? r[3].toString().trim().toUpperCase() : "";
    const qty=Number(r[4])||0;
    const harga=hargaMap[r[5]]||0;

    const okProduk=!produkDipilih || produk===produkDipilih;
    const okBulan=!bulanDipilih || bulanUTC==bulanDipilih;

    if(okProduk && okBulan){
      totalQty+=qty;
      totalRp+=qty*harga;
      produkTerjualSet.add(produk);
      outletTransaksi.add(outlet);
    }
  });

  /* ===== UPDATE KPI ===== */
  totalProdukEl.textContent=semuaProdukSet.size;
  totalProdukTerjualEl.textContent=produkTerjualSet.size;
  produkBelumTerjualEl.textContent=
    semuaProdukSet.size-produkTerjualSet.size;

  totalStokEl.textContent=totalStok;
  totalPenjualanEl.textContent=totalQty;
  totalPenjualanRpEl.textContent=
    "Rp "+totalRp.toLocaleString("id-ID");

  totalOutletAllEl.textContent=allOutlet.size;
  kpiOutletAktifEl.textContent=outletTransaksi.size;
  kpiOutletNonAktifEl.textContent=
    allOutlet.size-outletTransaksi.size;
}

/* ======================= EVENT ======================= */
filterProduk.addEventListener("change",updateKPI);
filterBulan.addEventListener("change",updateKPI);
</script>
</body>

</html>


























