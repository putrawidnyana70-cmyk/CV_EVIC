<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<link rel="icon" type="image/png" href="logo.png">
<title>Penjualan</title>
<link rel="stylesheet" href="style.css">
</head>

<body>
<div class="app">

<!-- SIDEBAR -->
<aside class="sidebar">
<div class="logo">
<img src="logo.jpg" alt="Logo">
<h2>Warehouse</h2>
</div>
<nav>
<a href="index.html" class="active">Penjualan</a>
<a href="penjualan.html">Audit Stok</a>
<a href="persediaan.html">Persediaan</a>
<a href="forecasting.html">Forecasting</a>
</nav>
</aside>

<!-- MAIN CONTENT -->
<main class="content">

<!-- LOADING -->
<div id="loading">
<img src="logo.jpg" alt="Loading">
<p>Memuat data...</p>
</div>

<header>
<h1>Penjualan</h1>
<p>Ringkasan persediaan & transaksi</p>

<div class="filter-bar">
<select id="filterProduk">
<option value="">Semua Produk</option>
</select>

<select id="filterBulan">
<option value="">Semua Bulan</option>
<option value="1">Januari</option>
<option value="2">Februari</option>
<option value="3">Maret</option>
<option value="4">April</option>
<option value="5">Mei</option>
<option value="6">Juni</option>
<option value="7">Juli</option>
<option value="8">Agustus</option>
<option value="9">September</option>
<option value="10">Oktober</option>
<option value="11">November</option>
<option value="12">Desember</option>
</select>
</div>
</header>

<section class="cards">
<div class="card">
<h3>Total Produk Terjual</h3>
<span id="totalProdukTerjual">0</span>
<small>Jumlah produk unik yang memiliki transaksi</small>
</div>

<div class="card">
<h3>Total Produk Aktif</h3>
<span id="totalProduk">0</span>
<small>Total seluruh produk yang tersedia</small>
</div>

<div class="card">
<h3>Produk Belum Terjual</h3>
<span id="produkBelumTerjual">0</span>
<small>Produk yang belum ada transaksi</small>
</div>

<div class="card">
<h3>Total Stok</h3>
<span id="totalStok">0</span>
</div>

<div class="card">
<h3>Total Penjualan (Qty)</h3>
<span id="totalPenjualan">0</span>
</div>

<div class="card">
<h3>Total Penjualan (Rp)</h3>
<span id="totalPenjualanRp">0</span>
</div>

<div class="card">
<h3>Total Outlet Keseluruhan</h3>
<span id="totalOutletAll">0</span>
</div>

<div class="card">
<h3>Outlet Transaksi</h3>
<span id="kpiOutletAktif">0</span>
</div>

<div class="card">
<h3>Outlet Tidak Transaksi</h3>
<span id="kpiOutletNonAktif">0</span>
</div>
</section>

<section class="chart-row">
<div class="chart-box">
<h3>Kontribusi Produk (Tinggi â†’ Rendah)</h3>
<canvas id="produkChart" height="320"></canvas>
</div>

<div class="chart-box">
<h3>Grafik Penjualan per Bulan</h3>
<canvas id="penjualanChart" height="320"></canvas>
</div>
</section>

<section class="chart-box">
<h3>Kontribusi Outlet (Terbanyak & Terendah)</h3>
<canvas id="outletChart" height="320"></canvas>
</section>

<section class="status-row">

<div class="status-box produk-box">
<div class="status-header">
<h3>Status Produk</h3>
<button id="exportProdukCSV" class="btn-export">Export CSV</button>
</div>
<div id="listProdukStatus"></div>
</div>

<div class="status-box outlet-box">
<div class="status-header">
<h3>Status Outlet</h3>
<button id="exportOutletCSV" class="btn-export">Export CSV</button>
</div>

<select id="filterStatusOutlet">
<option value="">Semua</option>
<option value="aktif">Sudah Transaksi</option>
<option value="nonaktif">Belum Transaksi</option>
</select>

<div id="listOutletStatus"></div>
</div>

</section>

</main>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

/* ======================= KONFIGURASI ======================= */
const API_URL = "https://script.google.com/macros/s/AKfycbzY3q9H0Rh-j4xq3rQmfyNiQBTRS_nECuWwouBEeNXMCDQwYHtBAj6Sic9KQ6P5aW7x/exec";

/* ======================= ELEMENT ======================= */
const filterProduk = document.getElementById("filterProduk");
const filterBulan = document.getElementById("filterBulan");
const loading = document.getElementById("loading");
const totalProdukEl = document.getElementById("totalProduk");
const totalStokEl = document.getElementById("totalStok");
const totalPenjualanEl = document.getElementById("totalPenjualan");
const totalPenjualanRpEl = document.getElementById("totalPenjualanRp");
const kpiOutletAktifEl = document.getElementById("kpiOutletAktif");
const kpiOutletNonAktifEl = document.getElementById("kpiOutletNonAktif");
const filterStatusOutlet = document.getElementById("filterStatusOutlet");
const listOutletStatus = document.getElementById("listOutletStatus");
const totalProdukTerjualEl = document.getElementById("totalProdukTerjual");
const produkBelumTerjualEl = document.getElementById("produkBelumTerjual");
const totalOutletAllEl = document.getElementById("totalOutletAll");
const listProdukStatus = document.getElementById("listProdukStatus");
const exportProdukBtn = document.getElementById("exportProdukCSV");
const exportOutletBtn = document.getElementById("exportOutletCSV");

/* ======================= STATE ======================= */
let penjualanRaw = [];
let persediaan = [];
let hargaMap = {};
let chart = null;
let masterOutlet = [];
let produkChart = null;
let outletChart = null;
let lastProdukBelumTerjual = [];
let lastOutletStatus = [];
let globalAllOutlet = new Set();
let globalOutletTransaksi = new Set();

/* ======================= LOADING CONTROL ======================= */
function showLoading() {
loading.style.display = "flex";
loading.style.opacity = "1";
loading.style.pointerEvents = "auto";
}

function hideLoading() {
loading.style.opacity = "0";
loading.style.pointerEvents = "none";
setTimeout(() => loading.style.display = "none", 300);
}

/* ======================= FETCH DATA ======================= */
showLoading();
fetch(API_URL)
.then(res => res.json())
.then(data => {

penjualanRaw = (data.penjualan || []).slice(1);
persediaan = (data.persediaan || []).slice(1);
masterOutlet = (data.masterOutlet || []).slice(1);

const masterHarga = (data.masterHarga || []).slice(1);
masterHarga.forEach(r => {
const sku = r[0];
const hargaJual = Number(r[3]) || 0;
if (sku) hargaMap[sku] = hargaJual;
});

initFilterBulan();
isiDropdownProduk();
buildChartOnce();
updateKPI();
hideLoading();

})
.catch(err => {
console.error("API Error:", err);
hideLoading();
});

/* ======================= INIT FILTER ======================= */
function initFilterBulan() {
filterBulan.value = new Date().getUTCMonth() + 1;
}

function isiDropdownProduk() {
const setProduk = new Set();
penjualanRaw.forEach(r => r[3] && setProduk.add(r[3]));
[...setProduk].sort().forEach(p => {
const opt = document.createElement("option");
opt.value = p;
opt.textContent = p;
filterProduk.appendChild(opt);
});
}

/* ======================= KPI ======================= */
function updateKPI() {

showLoading();

setTimeout(() => {

const produkDipilih = filterProduk.value;
const bulanDipilih = filterBulan.value;

const allOutlet = new Set();
const outletTransaksi = new Set();
const semuaProdukSet = new Set();
const produkTerjualSet = new Set();

const produkMap = {};
const outletMap = {};

let totalQty = 0;
let totalRp = 0;
let totalStok = 0;

/* MASTER OUTLET */
masterOutlet.forEach(r => {
if (!r[1]) return;
const outletClean = r[1].toString().normalize("NFKC").replace(/\u00A0/g," ").trim().replace(/\s+/g," ").toUpperCase();
if (outletClean !== "") allOutlet.add(outletClean);
});

/* MASTER PRODUK */
persediaan.forEach(r => {
const produk = r[1] ? r[1].toString().normalize("NFKC").replace(/\u00A0/g," ").trim().replace(/\s+/g," ").toUpperCase() : "";
const stok = Number(r[5]) || 0;
if (produk) semuaProdukSet.add(produk);
if (!produkDipilih || produk === produkDipilih) totalStok += stok;
});

/* PENJUALAN */
penjualanRaw.forEach(r => {

const bulanUTC = new Date(r[0]).getUTCMonth() + 1;
const outlet = r[2] ? r[2].toString().normalize("NFKC").replace(/\u00A0/g," ").trim().replace(/\s+/g," ").toUpperCase() : "";
const produk = r[3] ? r[3].toString().normalize("NFKC").replace(/\u00A0/g," ").trim().replace(/\s+/g," ").toUpperCase() : "";
const qty = Number(r[4]) || 0;
const sku = r[5];
const harga = hargaMap[sku] || 0;

const okProduk = !produkDipilih || produk === produkDipilih;
const okBulan = !bulanDipilih || bulanUTC == bulanDipilih;

if (okProduk && okBulan) {
totalQty += qty;
totalRp += qty * harga;
produkTerjualSet.add(produk);
outletTransaksi.add(outlet);
produkMap[produk] = (produkMap[produk] || 0) + qty;
}

if (!bulanDipilih || bulanUTC == bulanDipilih) {
outletMap[outlet] = (outletMap[outlet] || 0) + qty;
}

});

allOutlet.delete("");
outletTransaksi.delete("");
semuaProdukSet.delete("");
produkTerjualSet.delete("");

totalProdukTerjualEl.textContent = produkTerjualSet.size;
totalProdukEl.textContent = semuaProdukSet.size;
produkBelumTerjualEl.textContent = semuaProdukSet.size - produkTerjualSet.size;
totalStokEl.textContent = totalStok;
totalPenjualanEl.textContent = totalQty;
totalPenjualanRpEl.textContent = "Rp " + totalRp.toLocaleString("id-ID");
totalOutletAllEl.textContent = allOutlet.size;
kpiOutletAktifEl.textContent = outletTransaksi.size;
kpiOutletNonAktifEl.textContent = allOutlet.size - outletTransaksi.size;

renderProdukChart(produkMap);
renderOutletChart(outletMap);
renderOutletStatus(allOutlet, outletTransaksi);
renderProdukStatus(semuaProdukSet, produkTerjualSet);

hideLoading();

},150);
}

/* ======================= CHART GLOBAL ======================= */
function buildChartOnce() {

const monthly = Array(12).fill(0);

penjualanRaw.forEach(r => {
const idx = new Date(r[0]).getUTCMonth();
monthly[idx] += Number(r[4]) || 0;
});

if (chart) chart.destroy();

chart = new Chart(document.getElementById("penjualanChart"), {
type: "line",
data: {
labels: ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"],
datasets: [{
label: "Total Penjualan (Global)",
data: monthly,
borderWidth: 2,
tension: 0.3,
fill: false
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
scales: { y: { beginAtZero: true } }
}
});
}

/* ======================= GRAFIK PRODUK ======================= */
function renderProdukChart(dataMap){

if (!dataMap || Object.keys(dataMap).length === 0) {
if (produkChart) produkChart.destroy();
return;
}

const sorted = Object.entries(dataMap).sort((a,b)=>b[1]-a[1]).slice(0,10);
const labels = sorted.map(x=>x[0]);
const data = sorted.map(x=>x[1]);

if (produkChart) produkChart.destroy();

produkChart = new Chart(document.getElementById("produkChart"), {
type: "bar",
data: {
labels: labels,
datasets: [{ label: "Total Terjual", data: data }]
},
options: {
responsive: true,
maintainAspectRatio: false,
indexAxis: 'y',
plugins: { legend: { display: false }},
scales: { x: { beginAtZero: true }}
}
});
}

/* ======================= GRAFIK OUTLET ======================= */
function renderOutletChart(dataMap){

if (!dataMap || Object.keys(dataMap).length === 0) {
if (outletChart) outletChart.destroy();
return;
}

const sorted = Object.entries(dataMap).sort((a,b)=>b[1]-a[1]);
let combined = [];

if (sorted.length <= 10) combined = sorted;
else combined = [...sorted.slice(0,5), ...sorted.slice(-5)];

const labels = combined.map(x=>x[0]);
const data = combined.map(x=>x[1]);

if (outletChart) outletChart.destroy();

outletChart = new Chart(document.getElementById("outletChart"), {
type: "bar",
data: {
labels: labels,
datasets: [{ label: "Total Pembelian", data: data }]
},
options: {
responsive: true,
maintainAspectRatio: false,
indexAxis: 'y',
plugins: { legend: { display: false }},
scales: { x: { beginAtZero: true }}
}
});
}

/* ======================= EVENT ======================= */
filterProduk.addEventListener("change", updateKPI);
filterBulan.addEventListener("change", updateKPI);
filterStatusOutlet.addEventListener("change", updateKPI);

</script>

</body>
</html>
