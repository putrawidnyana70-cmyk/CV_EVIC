<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="logo.png">
    <title>Penjualan</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    
    <div class="app">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="logo">
                <img src="logo.jpg" alt="Logo">
                <h2>Warehouse</h2>
            </div>

            <nav>
                <a href="index.html" class="active">Penjualan</a>
                <a href="penjualan.html">Audit Stok</a>
                <a href="persediaan.html">Persediaan</a>
                <a href="forecasting.html">Forecasting</a>
            </nav>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="content">
            <!-- LOADING -->
<div id="loading">
  <img src="logo.jpg" alt="Loading">
  <p>Memuat data...</p>
</div>
            <header>
                <h1>Penjualan</h1>
                <p>Ringkasan persediaan & transaksi</p>
                <div class="filter-bar">
                    
  <div class="filter-bar">

  <!-- SEARCHABLE DROPDOWN PRODUK -->
  <div class="custom-select">
    <input 
      type="text" 
      id="searchStock" 
      placeholder="Cari produk..."
      autocomplete="off"
    >
    <div id="produkDropdown" class="dropdown-list"></div>
  </div>

  <!-- FILTER BULAN -->
  <select id="filterBulan">
    <option value="">Semua Bulan</option>
    <option value="1">Januari</option>
    <option value="2">Februari</option>
    <option value="3">Maret</option>
    <option value="4">April</option>
    <option value="5">Mei</option>
    <option value="6">Juni</option>
    <option value="7">Juli</option>
    <option value="8">Agustus</option>
    <option value="9">September</option>
    <option value="10">Oktober</option>
    <option value="11">November</option>
    <option value="12">Desember</option>
  </select>

</div>
            </header>

            <section class="cards">

<div class="card">
    <h3>Total Produk Terjual</h3>
    <span id="totalProdukTerjual">0</span>
    <small>Jumlah produk unik yang memiliki transaksi</small>
</div>

<div class="card">
    <h3>Total Produk Aktif</h3>
    <span id="totalProduk">0</span>
    <small>Total seluruh produk yang tersedia</small>
</div>

<div class="card">
    <h3>Produk Belum Terjual</h3>
    <span id="produkBelumTerjual">0</span>
    <small>Produk yang belum ada transaksi</small>
</div>

<div class="card">
    <h3>Total Stok</h3>
    <span id="totalStok">0</span>
</div>

<div class="card">
    <h3>Total Penjualan (Qty)</h3>
    <span id="totalPenjualan">0</span>
</div>

<div class="card">
  <h3>Total Penjualan (Rp)</h3>
  <span id="totalPenjualanRp">0</span>
</div>

<div class="card">
  <h3>Total Outlet Keseluruhan</h3>
  <span id="totalOutletAll">0</span>
</div>

<div class="card">
  <h3>Outlet Transaksi</h3>
  <span id="kpiOutletAktif">0</span>
</div>

<div class="card">
  <h3>Outlet Tidak Transaksi</h3>
  <span id="kpiOutletNonAktif">0</span>
</div>

</section>

<section class="chart-row">

<div class="chart-box">
  <h3>Kontribusi Produk (Tinggi â†’ Rendah)</h3>
  <canvas id="produkChart" height="320"></canvas>
</div>

<div class="chart-box">
  <h3>Grafik Penjualan per Bulan</h3>
  <canvas id="penjualanChart" height="320"></canvas>
</div>

</section>
<section class="chart-box">
  <h3>Kontribusi Outlet (Terbanyak & Terendah)</h3>
  <canvas id="outletChart" height="320"></canvas>
</section>

<section class="status-row">

 <div class="status-box produk-box">
  <div class="status-header">
    <h3>Status Produk</h3>
    <button id="exportProdukCSV" class="btn-export">Export CSV</button>
  </div>
  <div id="listProdukStatus"></div>
</div>

  <div class="status-box outlet-box">
  <div class="status-header">
    <h3>Status Outlet</h3>
    <button id="exportOutletCSV" class="btn-export">Export CSV</button>
  </div>

  <select id="filterStatusOutlet">
    <option value="">Semua</option>
    <option value="aktif">Sudah Transaksi</option>
    <option value="nonaktif">Belum Transaksi</option>
  </select>

  <div id="listOutletStatus"></div>
</div>

</section>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

 <script>
/* =======================
   KONFIGURASI
======================= */
const API_URL = "https://script.google.com/macros/s/AKfycbzY3q9H0Rh-j4xq3rQmfyNiQBTRS_nECuWwouBEeNXMCDQwYHtBAj6Sic9KQ6P5aW7x/exec";

/* =======================
   ELEMENT
======================= */
const searchStock = document.getElementById("searchStock");
const produkDropdown = document.getElementById("produkDropdown");
const filterBulan  = document.getElementById("filterBulan");
const loading      = document.getElementById("loading");

const totalProdukEl       = document.getElementById("totalProduk");
const totalStokEl         = document.getElementById("totalStok");
const totalPenjualanEl    = document.getElementById("totalPenjualan");
const totalPenjualanRpEl  = document.getElementById("totalPenjualanRp");
const kpiOutletAktifEl    = document.getElementById("kpiOutletAktif");
const kpiOutletNonAktifEl = document.getElementById("kpiOutletNonAktif");
const filterStatusOutlet  = document.getElementById("filterStatusOutlet");
const listOutletStatus    = document.getElementById("listOutletStatus");
const totalProdukTerjualEl = document.getElementById("totalProdukTerjual");
const produkBelumTerjualEl = document.getElementById("produkBelumTerjual");
const totalOutletAllEl     = document.getElementById("totalOutletAll");
const listProdukStatus = document.getElementById("listProdukStatus");
const exportProdukBtn = document.getElementById("exportProdukCSV");
const exportOutletBtn = document.getElementById("exportOutletCSV");

/* =======================
   STATE
======================= */
let allProdukList = [];
let penjualanRaw = [];
let persediaan = [];
let masterOutlet = [];
let hargaMap = {};
let chart, produkChart, outletChart;

/* =======================
   LOADING
======================= */
function showLoading() {
  loading.style.display = "flex";
}
function hideLoading() {
  loading.style.display = "none";
}

/* =======================
   FETCH DATA
======================= */
showLoading();

fetch(API_URL)
  .then(res => res.json())
  .then(data => {

    penjualanRaw = (data.penjualan || []).slice(1);
    persediaan   = (data.persediaan || []).slice(1);
    masterOutlet = (data.masterOutlet || []).slice(1);

    const masterHarga = (data.masterHarga || []).slice(1);
    masterHarga.forEach(r => {
      if (r[0]) hargaMap[r[0]] = Number(r[3]) || 0;
    });

    initFilterBulan();
    isiDropdownProduk();
    buildChartOnce();
    updateKPI();

    hideLoading();
  })
  .catch(err => {
    console.error("API Error:", err);
    hideLoading();
  });

/* =======================
   INIT
======================= */
function initFilterBulan() {
  filterBulan.value = new Date().getUTCMonth() + 1;
}

function isiDropdownProduk() {
  const setProduk = new Set();
  penjualanRaw.forEach(r => r[3] && setProduk.add(r[3]));
  allProdukList = [...setProduk].sort();
}

/* =======================
   AUTOCOMPLETE
======================= */
let typingTimer;

searchStock.addEventListener("input", function() {

  clearTimeout(typingTimer);

  typingTimer = setTimeout(() => {

    const keyword = this.value.toLowerCase().trim();
    produkDropdown.innerHTML = "";

    if (!keyword) {
      produkDropdown.style.display = "none";
      updateKPI();
      return;
    }

    const filtered = allProdukList.filter(p =>
      p.toLowerCase().includes(keyword)
    );

    filtered.slice(0,20).forEach(p => {
      const div = document.createElement("div");
      div.className = "dropdown-item";
      div.textContent = p;

      div.onclick = () => {
        searchStock.value = p;
        produkDropdown.style.display = "none";
        updateKPI();
      };

      produkDropdown.appendChild(div);
    });

    produkDropdown.style.display = filtered.length ? "block" : "none";
    updateKPI();

  }, 250);

});

document.addEventListener("click", e => {
  if (!e.target.closest(".custom-select")) {
    produkDropdown.style.display = "none";
  }
});

/* =======================
   KPI (NO LOADING)
======================= */
function updateKPI() {

  const produkKeyword = searchStock.value.toLowerCase().trim();
  const bulanDipilih  = filterBulan.value;

  const allOutlet = new Set();
  const outletTransaksi = new Set();
  const semuaProdukSet = new Set();
  const produkTerjualSet = new Set();

  let totalQty = 0;
  let totalRp  = 0;
  let totalStok = 0;

  masterOutlet.forEach(r => {
    if (r[1]) allOutlet.add(r[1].trim());
  });

  persediaan.forEach(r => {
    const produk = r[1] || "";
    const stok = Number(r[5]) || 0;
    semuaProdukSet.add(produk);

    if (!produkKeyword || produk.toLowerCase().includes(produkKeyword))
      totalStok += stok;
  });

  const produkMap = {};
  const outletMap = {};

  penjualanRaw.forEach(r => {

    const tgl = new Date(r[0]);
    const bulanUTC = tgl.getUTCMonth() + 1;
    const outlet = r[2] || "";
    const produk = r[3] || "";
    const qty = Number(r[4]) || 0;
    const sku = r[5];
    const harga = hargaMap[sku] || 0;

    const okProduk =
      !produkKeyword ||
      produk.toLowerCase().includes(produkKeyword);

    const okBulan =
      !bulanDipilih || bulanUTC == bulanDipilih;

    if (okProduk && okBulan) {
      totalQty += qty;
      totalRp += qty * harga;
      produkTerjualSet.add(produk);
      outletTransaksi.add(outlet);
      produkMap[produk] = (produkMap[produk] || 0) + qty;
      outletMap[outlet] = (outletMap[outlet] || 0) + qty;
    }
  });

  totalProdukTerjualEl.textContent = produkTerjualSet.size;
  totalProdukEl.textContent = semuaProdukSet.size;
  produkBelumTerjualEl.textContent =
    semuaProdukSet.size - produkTerjualSet.size;

  totalStokEl.textContent = totalStok;
  totalPenjualanEl.textContent = totalQty;
  totalPenjualanRpEl.textContent =
    "Rp " + totalRp.toLocaleString("id-ID");

  totalOutletAllEl.textContent = allOutlet.size;
  kpiOutletAktifEl.textContent = outletTransaksi.size;
  kpiOutletNonAktifEl.textContent =
    allOutlet.size - outletTransaksi.size;

  renderProdukChart(produkMap);
  renderOutletChart(outletMap);
}

/* =======================
   CHART GLOBAL
======================= */
function buildChartOnce() {
  const monthly = Array(12).fill(0);
  penjualanRaw.forEach(r => {
    const idx = new Date(r[0]).getUTCMonth();
    monthly[idx] += Number(r[4]) || 0;
  });

  if (chart) chart.destroy();

  chart = new Chart(
    document.getElementById("penjualanChart"),
    {
      type: "line",
      data: {
        labels: ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"],
        datasets: [{
          label: "Total Penjualan (Global)",
          data: monthly,
          borderWidth: 2,
          tension: 0.3
        }]
      },
      options: { responsive: true }
    }
  );
}
</script>
</body>

</html>
























