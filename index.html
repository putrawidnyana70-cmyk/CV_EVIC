<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="logo.png">
    <title>Dashboard Inventory</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- LOADING -->
<div id="loading">
  <img src="logo.jpg" alt="Loading">
  <p>Memuat data...</p>
</div>
    <div class="app">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="logo">
                <img src="logo.jpg" alt="Logo">
                <h2>Inventory</h2>
            </div>

            <nav>
                <a href="index.html" class="active">Dashboard</a>
                <a href="penjualan.html">Penjualan</a>
                <a href="persediaan.html">Persediaan</a>
            </nav>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="content">
            <header>
                <h1>Dashboard</h1>
                <p>Ringkasan persediaan & transaksi</p>
                <div class="filter-bar">
  <select id="filterProduk">
    <option value="">Semua Produk</option>
  </select>

  <select id="filterBulan">
    <option value="">Semua Bulan</option>
    <option value="1">Januari</option>
    <option value="2">Februari</option>
    <option value="3">Maret</option>
    <option value="4">April</option>
    <option value="5">Mei</option>
    <option value="6">Juni</option>
    <option value="7">Juli</option>
    <option value="8">Agustus</option>
    <option value="9">September</option>
    <option value="10">Oktober</option>
    <option value="11">November</option>
    <option value="12">Desember</option>
  </select>
</div>
            </header>

            <section class="cards">
              
    <div class="card">
        <h3>Total Produk</h3>
        <span id="totalProduk">0</span>
    </div>
    <div class="card">
        <h3>Total Stok</h3>
        <span id="totalStok">0</span>
    </div>
    <div class="card">
    <h3>Total Penjualan</h3>
    <span id="totalPenjualan">0</span>
</div>
<div class="card">
  <h3>Total Penjualan (Rp)</h3>
  <span id="totalPenjualanRp">0</span>
</div>
<div class="card">
  <h3>Outlet Transaksi</h3>
  <span id="kpiOutletAktif">0</span>
</div>

<div class="card">
  <h3>Outlet Tidak Transaksi</h3>
  <span id="kpiOutletNonAktif">0</span>
</div>
</section>
<section class="chart-box">
  <h3>Grafik Penjualan per Bulan</h3>
  <canvas id="penjualanChart" width="1000" height="320"></canvas>
</section>
<section class="outlet-status-box">
  <h3>Status Outlet</h3>

  <select id="filterStatusOutlet">
    <option value="">Semua</option>
    <option value="aktif">Sudah Transaksi</option>
    <option value="nonaktif">Belum Transaksi</option>
  </select>

  <div id="listOutletStatus"></div>
</section>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

   <script>
/* =======================
   KONFIGURASI
======================= */
const API_URL = "https://script.google.com/macros/s/AKfycbzY3q9H0Rh-j4xq3rQmfyNiQBTRS_nECuWwouBEeNXMCDQwYHtBAj6Sic9KQ6P5aW7x/exec";

/* =======================
   ELEMENT
======================= */
const filterProduk = document.getElementById("filterProduk");
const filterBulan  = document.getElementById("filterBulan");
const loading      = document.getElementById("loading");

const totalProdukEl       = document.getElementById("totalProduk");
const totalStokEl         = document.getElementById("totalStok");
const totalPenjualanEl    = document.getElementById("totalPenjualan");
const totalPenjualanRpEl  = document.getElementById("totalPenjualanRp");
const kpiOutletAktifEl    = document.getElementById("kpiOutletAktif");
const kpiOutletNonAktifEl = document.getElementById("kpiOutletNonAktif");
const filterStatusOutlet  = document.getElementById("filterStatusOutlet");
const listOutletStatus    = document.getElementById("listOutletStatus");

/* =======================
   STATE
======================= */
let penjualanRaw   = [];
let persediaan     = [];
let hargaMap       = {};
let chart          = null;
let masterOutlet = [];

/* =======================
   LOADING CONTROL
======================= */
function showLoading() {
  loading.style.display = "flex";
  loading.style.opacity = "1";
  loading.style.pointerEvents = "auto";
}

function hideLoading() {
  loading.style.opacity = "0";
  loading.style.pointerEvents = "none";
  setTimeout(() => loading.style.display = "none", 300);
}

/* =======================
   FETCH DATA (1x SAJA)
======================= */
showLoading();

fetch(API_URL)
  .then(res => res.json())
  .then(data => {
    penjualanRaw = (data.penjualan || []).slice(1);
    persediaan   = (data.persediaan || []).slice(1);
    masterOutlet = (data.masterOutlet || []).slice(1);

    // MASTER HARGA
    const masterHarga = (data.masterHarga || []).slice(1);
    masterHarga.forEach(r => {
      const sku = r[0];
      const hargaJual = Number(r[3]) || 0;
      if (sku) hargaMap[sku] = hargaJual;
    });

    initFilterBulan();
    isiDropdownProduk();

    buildChartOnce(); // grafik 1x
    updateKPI();      // KPI awal

    hideLoading();
  })
  .catch(err => {
    console.error("API Error:", err);
    hideLoading();
  });

/* =======================
   INIT FILTER
======================= */
function initFilterBulan() {
  filterBulan.value = new Date().getUTCMonth() + 1;
}

function isiDropdownProduk() {
  const setProduk = new Set();
  penjualanRaw.forEach(r => r[3] && setProduk.add(r[3]));

  [...setProduk].sort().forEach(p => {
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    filterProduk.appendChild(opt);
  });
}

/* =======================
   KPI (TERFILTER)
======================= */
function updateKPI() {
  showLoading();

  setTimeout(() => {
    const produkDipilih = filterProduk.value;
    const bulanDipilih  = filterBulan.value;

    const allOutlet = new Set();
    const outletTransaksi = new Set();

    let totalQty = 0;
    let totalRp  = 0;
    const produkSet = new Set();

    // ============================
    // 1️⃣ AMBIL SEMUA OUTLET DARI MASTER_OUTLET
    // ============================
    masterOutlet.forEach(r => {
      const namaOutlet = r[1]; // kolom Nama Outlet
      if (namaOutlet) allOutlet.add(namaOutlet);
    });

    // ============================
    // 2️⃣ HITUNG TRANSAKSI TERFILTER
    // ============================
    penjualanRaw.forEach(r => {

      const bulanUTC = new Date(r[0]).getUTCMonth() + 1;

      const outlet = r[2];
      const produk = r[3];
      const qty    = Number(r[4]) || 0;
      const sku    = r[5];
      const harga  = hargaMap[sku] || 0;

      const okProduk = !produkDipilih || produk === produkDipilih;
      const okBulan  = !bulanDipilih  || bulanUTC == bulanDipilih;

      if (okProduk && okBulan) {
        totalQty += qty;
        totalRp  += qty * harga;
        produkSet.add(produk);
        outletTransaksi.add(outlet);
      }
    });

    // ============================
    // 3️⃣ HITUNG STOK
    // ============================
    let totalStok = 0;
    persediaan.forEach(r => {
      const produk = r[1];
      const stok   = Number(r[5]) || 0;
      if (!produkDipilih || produk === produkDipilih) {
        totalStok += stok;
      }
    });

    // ============================
    // 4️⃣ UPDATE KPI UTAMA
    // ============================
    totalProdukEl.textContent      = produkSet.size || 0;
    totalStokEl.textContent        = totalStok;
    totalPenjualanEl.textContent   = totalQty;
    totalPenjualanRpEl.textContent = "Rp " + totalRp.toLocaleString("id-ID");

    // ============================
    // 5️⃣ HITUNG STATUS OUTLET
    // ============================
    const totalAktif = outletTransaksi.size;
    const totalNonAktif = allOutlet.size - totalAktif;

    kpiOutletAktifEl.textContent    = totalAktif;
    kpiOutletNonAktifEl.textContent = totalNonAktif;

    renderOutletStatus(allOutlet, outletTransaksi);

    hideLoading();
  }, 200);
}


/* =======================
   GRAFIK (GLOBAL, 1x)
======================= */
function buildChartOnce() {
  const monthly = Array(12).fill(0);

  penjualanRaw.forEach(r => {
    const idx = new Date(r[0]).getUTCMonth();
    monthly[idx] += Number(r[4]) || 0;
  });

  const ctx = document.getElementById("penjualanChart");
  if (!ctx) return;

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"],
      datasets: [{
        label: "Total Penjualan (Global)",
        data: monthly,
        borderWidth: 2,
        tension: 0.3,
        fill: false
      }]
    },
    options: {
      responsive: false,
      animation: false,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}
// =======================
// FUNCTION RENDER OUTLET
// =======================
function renderOutletStatus(allOutlet, outletTransaksi) {

  listOutletStatus.innerHTML = "";
  const statusFilter = filterStatusOutlet.value;

  [...allOutlet].sort().forEach(outlet => {

    const isAktif = outletTransaksi.has(outlet);

    if (statusFilter === "aktif" && !isAktif) return;
    if (statusFilter === "nonaktif" && isAktif) return;

    const div = document.createElement("div");
    div.className = "outlet-row";

    div.innerHTML = `
      <span>${outlet}</span>
      <span class="${isAktif ? 'badge-hijau' : 'badge-merah'}">
        ${isAktif ? 'Sudah Transaksi' : 'Belum Transaksi'}
      </span>
    `;

    listOutletStatus.appendChild(div);
  });
}

/* =======================
   EVENT
======================= */
filterProduk.addEventListener("change", updateKPI);
filterBulan.addEventListener("change", updateKPI);
filterStatusOutlet.addEventListener("change", updateKPI);

</script>
</body>
</html>