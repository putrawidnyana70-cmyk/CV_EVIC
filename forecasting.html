<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="logo.png">
    <title>Forecasting</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- LOADING -->
<div id="loading">
  <img src="logo.jpg" alt="Loading">
  <p>Memuat data...</p>
</div>
    <div class="app">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="logo">
                <img src="logo.jpg" alt="Logo">
                <h2>Inventory</h2>
            </div>

            <nav>
                <a href="index.html">Dashboard</a>
                <a href="penjualan.html">Penjualan</a>
                <a href="persediaan.html">Persediaan</a>
                <a href="forecasting.html" class="active">Forecasting</a>
            </nav>
        </aside>

  <!-- CONTENT -->
  <main class="content">
    <header>
      <h1>Forecasting</h1>
      <p>Perencanaan kebutuhan produk & dana pembelian</p>

      <div class="filter-bar">
        <select id="filterProduk">
          <option value="">Semua Produk</option>
        </select>

        <select id="filterBulan">
          <option value="1">Januari</option>
          <option value="2">Februari</option>
          <option value="3">Maret</option>
          <option value="4">April</option>
          <option value="5">Mei</option>
          <option value="6">Juni</option>
          <option value="7">Juli</option>
          <option value="8">Agustus</option>
          <option value="9">September</option>
          <option value="10">Oktober</option>
          <option value="11">November</option>
          <option value="12">Desember</option>
        </select>

        <select id="filterTahun">
          <option value="2026">2026</option>
          <option value="2025">2025</option>
        </select>
      </div>
    </header>

    <!-- KPI -->
    <section class="cards">
      <div class="card">
        <h3>Forecast Qty</h3>
        <span id="forecastQty">0</span>
      </div>

      <div class="card">
        <h3>Forecast Value (Rp)</h3>
        <span id="forecastValue">0</span>
      </div>

      <div class="card">
        <h3>Actual Qty</h3>
        <span id="actualQty">0</span>
      </div>

      <div class="card">
        <h3>Akurasi Forecast</h3>
        <span id="akurasi">-</span>
      </div>

      <div class="card">
        <h3>Total Forecast Semua Produk</h3>
        <span id="totalForecast">0</span>
      </div>
    </section>
      <section class="table-container">
  <h3 style="margin-bottom:15px;">Forecast Detail</h3>
  <table>
    <thead>
      <tr>
        <th>Produk</th>
        <th>Forecast Qty</th>
        <th>Harga Beli</th>
        <th>Forecast Value</th>
      </tr>
    </thead>
    <tbody id="forecastTableBody"></tbody>
  </table>
</section>

  </main>
</div>

<script>

/* ================= CONFIG ================= */
const API_URL = "YOUR_API_URL_HERE";

/* ================= ELEMENT ================= */
const filterProduk = document.getElementById("filterProduk");
const filterBulan  = document.getElementById("filterBulan");
const filterTahun  = document.getElementById("filterTahun");
const loading      = document.getElementById("loading");

/* ================= STATE ================= */
let penjualanRaw = [];
let masterHistory = [];
let masterProduk = [];
let hargaMap = {};
let produkMap = {}; // SKU -> Nama Produk

/* ================= LOADING ================= */
function showLoading(){
  loading.style.display="flex";
}
function hideLoading(){
  loading.style.display="none";
}

/* ================= FETCH ================= */
showLoading();

fetch(API_URL)
.then(res=>res.json())
.then(data=>{

  penjualanRaw  = (data.penjualan || []).slice(1);
  masterHistory = (data.masterHistory || []).slice(1);
  masterProduk  = (data.masterProduk || []).slice(1);

  // Mapping Produk
  masterProduk.forEach(r=>{
    const sku = String(r[0]).trim();
    const nama = r[1];
    if(sku) produkMap[sku] = nama;
  });

  // Mapping Harga Beli
  (data.masterHarga || []).slice(1).forEach(r=>{
    const sku = String(r[0]).trim();
    const harga = Number(r[2]) || 0;
    hargaMap[sku] = harga;
  });

  isiDropdown();
  updateForecast();
  hideLoading();

});

/* ================= DROPDOWN ================= */
function isiDropdown(){

  filterProduk.innerHTML = "";

  const optAll = document.createElement("option");
  optAll.value = "";
  optAll.textContent = "Semua Produk";
  filterProduk.appendChild(optAll);

  const skuSet = new Set();

  penjualanRaw.forEach(r=>{
    if(r[5]) skuSet.add(String(r[5]).trim());
  });

  masterHistory.forEach(r=>{
    if(r[4]) skuSet.add(String(r[4]).trim());
  });

  [...skuSet].sort().forEach(sku=>{
    const opt = document.createElement("option");
    opt.value = sku;
    opt.textContent = produkMap[sku] || sku;
    filterProduk.appendChild(opt);
  });

}

/* ================= FORECAST ================= */
function hitungForecast(sku, bulan, tahun){

  const mapBulan = {
    Januari:1, Februari:2, Maret:3, April:4,
    Mei:5, Juni:6, Juli:7, Agustus:8,
    September:9, Oktober:10, November:11, Desember:12
  };

  let dataSKU = [];

  masterHistory.forEach(r=>{
    const th = Number(r[1]);
    const bl = mapBulan[String(r[2]).trim()];
    const qty = Number(r[3]) || 0;
    const skuData = String(r[4]).trim();

    if(skuData === sku){
      dataSKU.push({tahun: th, bulan: bl, qty: qty});
    }
  });

  dataSKU.sort((a,b)=>{
    if(a.tahun!==b.tahun) return a.tahun-b.tahun;
    return a.bulan-b.bulan;
  });

  const index = dataSKU.findIndex(d=>d.tahun===tahun && d.bulan===bulan);
  const i = index===-1 ? dataSKU.length : index;

  const last3 = dataSKU.slice(Math.max(0,i-3), i);

  if(last3.length===0) return 0;

  let forecast=0;

  if(last3.length===1){
    forecast=last3[0].qty;
  } else if(last3.length===2){
    forecast=(last3[0].qty*0.4)+(last3[1].qty*0.6);
  } else {
    forecast=
      (last3[0].qty*0.2)+
      (last3[1].qty*0.3)+
      (last3[2].qty*0.5);
  }

  return Math.round(forecast*1.10); // +10% safety
}

/* ================= UPDATE ================= */
function updateForecast(){

  const sku = filterProduk.value;
  const bulan = Number(filterBulan.value);
  const tahun = Number(filterTahun.value);

  let totalForecast=0;
  let totalActual=0;

  const allSKU = new Set([
    ...penjualanRaw.map(r=>String(r[5]).trim()),
    ...masterHistory.map(r=>String(r[4]).trim())
  ]);

  const tbody = document.getElementById("forecastBody");
  tbody.innerHTML="";

  allSKU.forEach(s=>{

    if(sku && s!==sku) return;

    const forecastQty = hitungForecast(s,bulan,tahun);

    // ACTUAL DARI PENJUALAN
    let actualQty=0;
    penjualanRaw.forEach(r=>{
      const date = new Date(r[0]);
      const th = date.getFullYear();
      const bl = date.getMonth()+1;
      const skuData = String(r[5]).trim();

      if(skuData===s && th===tahun && bl===bulan){
        actualQty+=Number(r[4])||0;
      }
    });

    const harga = hargaMap[s]||0;
    const value = forecastQty*harga;

    totalForecast+=forecastQty;
    totalActual+=actualQty;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${produkMap[s]||s}</td>
      <td>${forecastQty}</td>
      <td>${actualQty}</td>
      <td>Rp ${harga.toLocaleString("id-ID")}</td>
      <td>Rp ${value.toLocaleString("id-ID")}</td>
    `;
    tbody.appendChild(tr);

  });

  document.getElementById("forecastQty").textContent = totalForecast;
  document.getElementById("actualQty").textContent = totalActual;
  document.getElementById("forecastValue").textContent =
    "Rp "+(totalForecast*(hargaMap[sku]||0)).toLocaleString("id-ID");

}

/* ================= EVENT ================= */
filterProduk.addEventListener("change",updateForecast);
filterBulan.addEventListener("change",updateForecast);
filterTahun.addEventListener("change",updateForecast);

</script>
</body>

</html>








