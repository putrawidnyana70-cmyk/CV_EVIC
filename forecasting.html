<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="logo.png">
    <title>Forecasting</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- LOADING -->
<div id="loading">
  <img src="logo.jpg" alt="Loading">
  <p>Memuat data...</p>
</div>
    <div class="app">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="logo">
                <img src="logo.jpg" alt="Logo">
                <h2>Warehouse</h2>
            </div>

            <nav>
                <a href="index.html">Penjualan</a>
                <a href="penjualan.html">Audit Stok</a>
                <a href="persediaan.html">Persediaan</a>
                <a href="forecasting.html" class="active">Forecasting</a>
            </nav>
        </aside>

  <!-- CONTENT -->
  <main class="content">
    <header>
      <h1>Forecasting</h1>
      <p>Perencanaan kebutuhan produk & dana pembelian</p>

      <div class="filter-bar">
        <select id="filterProduk">
          <option value="">Semua Produk</option>
        </select>

        <select id="filterBulan">
          <option value="1">Januari</option>
          <option value="2">Februari</option>
          <option value="3">Maret</option>
          <option value="4">April</option>
          <option value="5">Mei</option>
          <option value="6">Juni</option>
          <option value="7">Juli</option>
          <option value="8">Agustus</option>
          <option value="9">September</option>
          <option value="10">Oktober</option>
          <option value="11">November</option>
          <option value="12">Desember</option>
        </select>

        <select id="filterTahun">
          <option value="2026">2026</option>
          <option value="2025">2025</option>
        </select>
      </div>
        <div class="kategori-bar">
  <button class="btn-kategori active" data-kategori="">Semua</button>
  <button class="btn-kategori" data-kategori="Modul">Modul</button>
  <button class="btn-kategori" data-kategori="Poster">Poster</button>
  <button class="btn-kategori" data-kategori="Panduan">Panduan</button>
  <button class="btn-kategori" data-kategori="Seragam">Seragam</button>
  <button class="btn-kategori" data-kategori="Lain-lain">Lain-lain</button>
</div>
    </header>

    <!-- KPI -->
    <section class="cards">
      <div class="card">
        <h3>Forecast Qty</h3>
        <span id="forecastQty">0</span>
      </div>

      <div class="card">
        <h3>Forecast Value (Rp)</h3>
        <span id="forecastValue">0</span>
      </div>

      <div class="card">
        <h3>Actual Qty</h3>
        <span id="actualQty">0</span>
      </div>

      <div class="card">
        <h3>Akurasi Forecast</h3>
        <span id="akurasi">-</span>
      </div>

      <div class="card">
        <h3>Total Forecast Semua Produk</h3>
        <span id="totalForecast">0</span>
      </div>
    </section>
      <section class="table-container">
  <h3 style="margin-bottom:15px;">Forecast Detail</h3>
  <table>
    <thead>
  <tr>
    <th>Produk</th>
    <th>Forecast Qty</th>
    <th>Actual Qty</th>
    <th>Selisih</th>
    <th>Harga Beli</th>
    <th>Forecast Value</th>
  </tr>
</thead>
    <tbody id="forecastTableBody"></tbody>
  </table>
</section>

  </main>
</div>

<script>

/* =========================================================
   ======================= CONFIG ==========================
========================================================= */
const API_URL = "https://script.google.com/macros/s/AKfycbyjpAukfJYA-lEXqV6F2HfOFlOLSOw-BUCiS_boUxfZISsv-DBsun0xiIkqeChRWluJ/exec";


/* =========================================================
   ======================= ELEMENT =========================
========================================================= */
const filterProduk = document.getElementById("filterProduk");
const filterBulan  = document.getElementById("filterBulan");
const filterTahun  = document.getElementById("filterTahun");
const loading      = document.getElementById("loading");
const tableBody    = document.getElementById("forecastTableBody");


/* =========================================================
   ========================= STATE =========================
========================================================= */
let penjualanRaw = [];
let masterHistory = [];
let masterProduk = [];
let hargaMap = {};
let produkMap = {};
let historiGabungan = {};
let kategoriAktif = "";


/* =========================================================
   ======================== LOADING ========================
========================================================= */
function showLoading(){ if(loading) loading.style.display="flex"; }
function hideLoading(){ if(loading) loading.style.display="none"; }


/* =========================================================
   ========================= FETCH =========================
========================================================= */
async function loadData(){

  try{
    showLoading();

    const res = await fetch(API_URL);
    const data = await res.json();

    penjualanRaw  = (data.penjualan || []).slice(1);
    masterHistory = (data.masterHistory || []).slice(1);
    masterProduk  = (data.masterProduk || []).slice(1);

    // Mapping Produk
    masterProduk.forEach(r=>{
      const sku = String(r[0]).trim();
      if(sku) produkMap[sku] = r[1];
    });

    // Mapping Harga
    (data.masterHarga || []).slice(1).forEach(r=>{
      const sku = String(r[0]).trim();
      hargaMap[sku] = Number(r[2]) || 0;
    });

    bangunHistoriGabungan();
    isiDropdown();
    updateForecast();

  }catch(err){
    console.error("ERROR:", err);
  }finally{
    hideLoading();
  }

}

loadData();


/* =========================================================
   ================= GABUNG HISTORI DATA ===================
========================================================= */
function bangunHistoriGabungan(){

  historiGabungan = {};

  const mapBulan = {
    Januari:1, Februari:2, Maret:3, April:4,
    Mei:5, Juni:6, Juli:7, Agustus:8,
    September:9, Oktober:10, November:11, Desember:12
  };

  // Dari MasterHistory
  masterHistory.forEach(r=>{
    const sku = String(r[4]).trim();
    const tahun = Number(r[1]);
    const bulan = mapBulan[String(r[2]).trim()];
    const qty = Number(r[3]) || 0;

    if(!historiGabungan[sku]) historiGabungan[sku] = [];
    historiGabungan[sku].push({tahun, bulan, qty});
  });

  // Dari Penjualan
  penjualanRaw.forEach(r=>{
    const date = new Date(r[0]);
    const sku = String(r[5]).trim();
    const tahun = date.getFullYear();
    const bulan = date.getMonth()+1;
    const qty = Number(r[4]) || 0;

    if(!historiGabungan[sku]) historiGabungan[sku] = [];

    const existing = historiGabungan[sku]
      .find(d=>d.tahun===tahun && d.bulan===bulan);

    if(existing) existing.qty += qty;
    else historiGabungan[sku].push({tahun, bulan, qty});
  });

  // Urutkan histori
  Object.keys(historiGabungan).forEach(sku=>{
    historiGabungan[sku].sort((a,b)=>{
      if(a.tahun!==b.tahun) return a.tahun-b.tahun;
      return a.bulan-b.bulan;
    });
  });
}


/* =========================================================
   ===================== DROPDOWN PRODUK ===================
========================================================= */
function isiDropdown(){

  if(!filterProduk) return;

  filterProduk.innerHTML = "";

  const optAll = document.createElement("option");
  optAll.value = "";
  optAll.textContent = "Semua Produk";
  filterProduk.appendChild(optAll);

  Object.keys(historiGabungan).sort().forEach(sku=>{
    const opt = document.createElement("option");
    opt.value = sku;
    opt.textContent = produkMap[sku] || sku;
    filterProduk.appendChild(opt);
  });

}


/* =========================================================
   ==================== KATEGORI PRODUK ====================
========================================================= */
function getKategori(namaProduk){

  if(!namaProduk) return "Lain-lain";

  const kataDepan = namaProduk.trim().split(" ")[0].toLowerCase();

  if(kataDepan === "modul") return "Modul";
  if(kataDepan === "buku") return "Panduan";
  if(kataDepan === "poster" || kataDepan === "flash") return "Poster";

  if(["merah","kuning","biru","my"].includes(kataDepan))
    return "Seragam";

  return "Lain-lain";
}


/* =========================================================
   ==================== PEMBULATAN NAIK ====================
========================================================= */
function pembulatanNaik(angka){

  if(angka <= 0) return 0;
  if(angka < 10) return 10;
  if(angka < 100) return Math.ceil(angka/10)*10;
  if(angka < 1000) return Math.ceil(angka/50)*50;
  return Math.ceil(angka/100)*100;

}


/* =========================================================
   ======================= FORECAST ========================
========================================================= */
function hitungForecast(sku, bulan, tahun){

  const data = historiGabungan[sku] || [];

  const index = data.findIndex(d=>d.tahun===tahun && d.bulan===bulan);
  const i = index===-1 ? data.length : index;
  const last3 = data.slice(Math.max(0,i-3), i);

  if(last3.length===0) return 0;

  let forecast = 0;

  if(last3.length===1) forecast = last3[0].qty;
  else if(last3.length===2)
    forecast = (last3[0].qty*0.4)+(last3[1].qty*0.6);
  else
    forecast =
      (last3[0].qty*0.2)+
      (last3[1].qty*0.3)+
      (last3[2].qty*0.5);

  const withSafety = Math.round(forecast*1.10);
  return pembulatanNaik(withSafety);

}


/* =========================================================
   ======================= AKURASI =========================
========================================================= */
function hitungAkurasi(actual,forecast){
  if(actual===0) return "-";
  const error = Math.abs(actual-forecast);
  return (100-((error/actual)*100)).toFixed(1)+"%";
}


/* =========================================================
   ======================= UPDATE UI =======================
========================================================= */
function updateForecast(){

  const skuFilter = filterProduk?.value || "";
  const bulan = Number(filterBulan?.value);
  const tahun = Number(filterTahun?.value);

  let totalForecast=0;
  let totalActual=0;
  let totalValue=0;

  if(tableBody) tableBody.innerHTML="";

  Object.keys(historiGabungan).forEach(sku=>{

    const namaProduk = produkMap[sku] || sku;
    const kategoriProduk = getKategori(namaProduk);

    if(skuFilter && sku!==skuFilter) return;
    if(kategoriAktif && kategoriProduk!==kategoriAktif) return;

    const forecastQty = hitungForecast(sku,bulan,tahun);

    let actualQty=0;
    penjualanRaw.forEach(r=>{
      const date=new Date(r[0]);
      if(
        String(r[5]).trim()===sku &&
        date.getFullYear()===tahun &&
        date.getMonth()+1===bulan
      ){
        actualQty+=Number(r[4])||0;
      }
    });

    const harga = hargaMap[sku]||0;
    const value = forecastQty*harga;

    totalForecast+=forecastQty;
    totalActual+=actualQty;
    totalValue+=value;

    if(tableBody){
      const selisih = forecastQty-actualQty;

      const warnaSelisih =
        selisih>0 ? "orange" :
        selisih<0 ? "red" : "green";

      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${namaProduk}</td>
        <td>${forecastQty}</td>
        <td>${actualQty}</td>
        <td style="color:${warnaSelisih};font-weight:bold">${selisih}</td>
        <td>Rp ${harga.toLocaleString("id-ID")}</td>
        <td>Rp ${value.toLocaleString("id-ID")}</td>
      `;
      tableBody.appendChild(tr);
    }

  });

  document.getElementById("forecastQty").textContent = totalForecast;
  document.getElementById("actualQty").textContent = totalActual;
  document.getElementById("forecastValue").textContent =
    "Rp "+totalValue.toLocaleString("id-ID");
  document.getElementById("totalForecast").textContent = totalForecast;
  document.getElementById("akurasi").textContent =
    hitungAkurasi(totalActual,totalForecast);

}


/* =========================================================
   ========================= EVENT =========================
========================================================= */

// Filter dropdown
filterProduk?.addEventListener("change",updateForecast);
filterBulan?.addEventListener("change",updateForecast);
filterTahun?.addEventListener("change",updateForecast);

// Filter kategori button
document.querySelectorAll(".btn-kategori").forEach(btn=>{
  btn.addEventListener("click",function(){

    document.querySelectorAll(".btn-kategori")
      .forEach(b=>b.classList.remove("active"));

    this.classList.add("active");
    kategoriAktif = this.dataset.kategori;
    updateForecast();

  });
});

</script>
</body>

</html>



















