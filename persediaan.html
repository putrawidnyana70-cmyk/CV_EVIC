<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Persediaan</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<!-- LOADING -->
<div id="loading">
  <img src="logo.jpg" alt="Loading">
  <p>Memuat data...</p>
</div>
<div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="logo">
            <img src="logo.jpg" alt="Logo">
            <h2>Inventory</h2>
        </div>

        <nav>
            <a href="index.html">Dashboard</a>
            <a href="penjualan.html">Penjualan</a>
            <a href="persediaan.html" class="active">Persediaan</a>
        </nav>
    </aside>

    <!-- CONTENT -->
    <main class="content">
        <header>
            <h1>Persediaan</h1>
            <p>Daftar stok produk</p>
        </header>

        <!-- SEARCH -->
        <div class="filter-bar">
  <input type="text" id="searchStock" placeholder="Cari SKU atau Nama Produk">


  <select id="filterBulan">
    <option value="">Semua Bulan</option>
    <option value="1">Januari</option>
    <option value="2">Februari</option>
    <option value="3">Maret</option>
    <option value="4">April</option>
    <option value="5">Mei</option>
    <option value="6">Juni</option>
    <option value="7">Juli</option>
    <option value="8">Agustus</option>
    <option value="9">September</option>
    <option value="10">Oktober</option>
    <option value="11">November</option>
    <option value="12">Desember</option>
  </select>
</div>

        <!-- TABLE -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>Produk</th>
                        <th>Saldo Awal</th>
                        <th>Stok Masuk</th>
                        <th>Stok Keluar</th>
                        <th>Stok Akhir</th>
                    </tr>
                </thead>
                <tbody id="stokBody">
                   
                </tbody>
            </table>
        </div>
    </main>
</div>

<script>
/* ================= KONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbw7rTjjw37nRJ9kgQLHWSdfnO-1qLrjB6Z6yHF1yA8scm4CmZ3PrK49TXb-EB32tBWl/exec";
const TAHUN_AKTIF = 2026;

/* ================= DOM ================= */
const tbody = document.getElementById("stokBody");
const filterBulan = document.getElementById("filterBulan");
const searchStock = document.getElementById("searchStock");
const loading = document.getElementById("loading");

/* ================= DATA ================= */
let masterProduk = [];
let pembelian = [];
let penjualan = [];

/* ================= LOADING CONTROL ================= */
function showLoading() {
  loading.style.display = "flex";
  loading.style.opacity = "1";
  loading.style.pointerEvents = "auto";
}
function hideLoading() {
  loading.style.opacity = "0";
  loading.style.pointerEvents = "none";
  setTimeout(() => loading.style.display = "none", 300);
}

/* =====================================================
   DATE PARSER (FINAL – ISO UTC DARI GAS)
   ===================================================== */
function parseSheetDate(tgl) {
  if (!tgl) return null;

  if (typeof tgl === "string" && tgl.endsWith("Z")) {
    const d = new Date(tgl);
    return {
      tahun: d.getUTCFullYear(),
      bulan: d.getUTCMonth() + 1
    };
  }

  const s = String(tgl).toLowerCase().trim();
  const map = {
    januari:1,februari:2,maret:3,april:4,mei:5,juni:6,
    juli:7,agustus:8,september:9,oktober:10,november:11,desember:12
  };
  const p = s.split(" ");
  if (p.length >= 3 && map[p[1]]) {
    return { tahun: +p[2], bulan: map[p[1]] };
  }

  return null;
}

/* ================= FETCH ================= */
showLoading();

fetch(API_URL)
  .then(r => r.json())
  .then(data => {
    masterProduk = data.masterProduk || [];
    pembelian = data.pembelian || [];
    penjualan = data.penjualan || [];

    // otomatis pilih bulan saat web dibuka
    const now = new Date();
    filterBulan.value = String(now.getMonth() + 1);

    render();
    hideLoading();
  })
  .catch(err => {
    console.error("API error:", err);
    hideLoading();
  });

/* =====================================================
   RENDER – ROLLING STOK BULANAN
   ===================================================== */
function render() {
  tbody.innerHTML = "";
  const bulanDipilih = Number(filterBulan.value) || 1;

  masterProduk.forEach((mp, idx) => {
    if (idx === 0) return; // skip header

    const sku = String(mp[0] || "").trim();
    if (!sku || sku.toLowerCase() === "sku") return;

    const nama = mp[1] || "-";
    let stok = Number(mp[2]) || 0;

    let saldoAwal = stok;
    let masuk = 0;
    let keluar = 0;

    for (let b = 1; b <= bulanDipilih; b++) {
      let beliBulan = 0;
      let jualBulan = 0;

      pembelian.forEach(p => {
        const d = parseSheetDate(p[0]);
        if (!d || d.tahun !== TAHUN_AKTIF) return;
        if (String(p[5]).trim() !== sku) return;
        if (d.bulan === b) beliBulan += Number(p[4]) || 0;
      });

      penjualan.forEach(p => {
        const d = parseSheetDate(p[0]);
        if (!d || d.tahun !== TAHUN_AKTIF) return;
        if (String(p[5]).trim() !== sku) return;
        if (d.bulan === b) jualBulan += Number(p[4]) || 0;
      });

      if (b === bulanDipilih) {
        saldoAwal = stok;
        masuk = beliBulan;
        keluar = jualBulan;
      }

      stok += beliBulan - jualBulan;
    }

    tbody.innerHTML += `
      <tr>
        <td>${sku}</td>
        <td>${nama}</td>
        <td>${saldoAwal}</td>
        <td>${masuk}</td>
        <td>${keluar}</td>
        <td><b>${stok}</b></td>
      </tr>
    `;
  });

  applySearch();
}

/* ================= SEARCH ================= */
function applySearch() {
  const key = searchStock.value.toLowerCase();
  document.querySelectorAll("#stokBody tr").forEach(r => {
    r.style.display =
      r.children[0].innerText.toLowerCase().includes(key) ||
      r.children[1].innerText.toLowerCase().includes(key)
        ? ""
        : "none";
  });
}

/* ================= EVENT ================= */
filterBulan.addEventListener("change", () => {
  showLoading();
  setTimeout(() => {
    render();
    hideLoading();
  }, 200);
});

searchStock.addEventListener("keyup", applySearch);
</script>

</body>
</html>