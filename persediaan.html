<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="logo.png">
    <title>Persediaan</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<!-- LOADING -->
<div id="loading">
  <img src="logo.jpg" alt="Loading">
  <p>Memuat data...</p>
</div>
<div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="logo">
            <img src="logo.jpg" alt="Logo">
            <h2>Inventory</h2>
        </div>

        <nav>
            <a href="index.html">Dashboard</a>
            <a href="penjualan.html">Penjualan</a>
            <a href="persediaan.html" class="active">Persediaan</a>
            <a href="forecasting.html">Forecasting</a>
        </nav>
    </aside>

    <!-- CONTENT -->
    <main class="content">
        <header>
            <h1>Persediaan</h1>
            <p>Daftar stok produk</p>
        </header>

        <!-- SEARCH -->
        <div class="filter-bar">
  <input type="text" id="searchStock" placeholder="Cari SKU atau Nama Produk">


  <select id="filterBulan">
    <option value="">Semua Bulan</option>
    <option value="1">Januari</option>
    <option value="2">Februari</option>
    <option value="3">Maret</option>
    <option value="4">April</option>
    <option value="5">Mei</option>
    <option value="6">Juni</option>
    <option value="7">Juli</option>
    <option value="8">Agustus</option>
    <option value="9">September</option>
    <option value="10">Oktober</option>
    <option value="11">November</option>
    <option value="12">Desember</option>
  </select>
</div>
        <!-- FILTER KATEGORI -->
<div class="kategori-bar">
  <button class="btn-kategori active" data-kategori="">Semua</button>
  <button class="btn-kategori" data-kategori="Modul">Modul</button>
  <button class="btn-kategori" data-kategori="Poster">Poster</button>
  <button class="btn-kategori" data-kategori="Panduan">Panduan</button>
  <button class="btn-kategori" data-kategori="Seragam">Seragam</button>
  <button class="btn-kategori" data-kategori="Lain-lain">Lain-lain</button>
</div>
        <div class="export-container">
  <button id="printSO" class="btn-export">
    Print SO
  </button>
</div>

        <!-- TABLE -->
        <div class="table-container">
            <table>
                <thead>
<tr>
  <th>SKU</th>
  <th>Produk</th>
  <th>Saldo Awal</th>
  <th>Stok Masuk</th>
  <th>Stok Keluar</th>
  <th>Stok Akhir</th>
  <th>Forecast</th>
  <th>Restock</th>
</tr>
</thead>
                <tbody id="stokBody">
                   
                </tbody>
            </table>
        </div>
    </main>
</div>

<script>

/* ================= KONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbw7rTjjw37nRJ9kgQLHWSdfnO-1qLrjB6Z6yHF1yA8scm4CmZ3PrK49TXb-EB32tBWl/exec";
const TAHUN_AKTIF = 2026;

/* ================= DOM ================= */
const tbody = document.getElementById("stokBody");
const filterBulan = document.getElementById("filterBulan");
const searchStock = document.getElementById("searchStock");
const loading = document.getElementById("loading");
const printBtn = document.getElementById("printSO");

/* ================= STATE ================= */
let masterProduk = [];
let pembelian = [];
let penjualan = [];
let kategoriAktif = "";

/* ================= LOADING ================= */
function showLoading(){ loading.style.display="flex"; }
function hideLoading(){ loading.style.display="none"; }

/* ================= KATEGORI DETECTOR ================= */
function getKategori(nama){

  if(!nama) return "Lain-lain";

  const kata = nama.trim().split(" ")[0].toLowerCase();

  if(kata==="modul") return "Modul";
  if(kata==="buku") return "Panduan";
  if(kata==="poster" || kata==="flash") return "Poster";
  if(["merah","kuning","biru","my"].includes(kata)) return "Seragam";

  return "Lain-lain";
}

/* ================= FETCH ================= */
showLoading();

fetch(API_URL)
.then(r=>r.json())
.then(data=>{
  masterProduk = data.masterProduk || [];
  pembelian = data.pembelian || [];
  penjualan = data.penjualan || [];

  const now = new Date();
  filterBulan.value = String(now.getMonth()+1);

  render();
  hideLoading();
})
.catch(err=>{
  console.error(err);
  hideLoading();
});

/* ================= DATE PARSER ================= */
function parseSheetDate(tgl){
  if(!tgl) return null;
  if(typeof tgl==="string" && tgl.endsWith("Z")){
    const d=new Date(tgl);
    return {tahun:d.getUTCFullYear(),bulan:d.getUTCMonth()+1};
  }
  return null;
}

/* ================= FORECAST ================= */
function hitungForecastPerProduk(sku,bulanAktif){

  let total=0,count=0;

  for(let b=bulanAktif-3;b<bulanAktif;b++){
    if(b<=0) continue;
    let totalB=0;

    penjualan.forEach(p=>{
      const d=parseSheetDate(p[0]);
      if(!d || d.tahun!==TAHUN_AKTIF) return;
      if(String(p[5]).trim()!==sku) return;
      if(d.bulan===b) totalB+=Number(p[4])||0;
    });

    if(totalB>0){ total+=totalB; count++; }
  }

  if(count===0) return 0;
  return Math.round(total/count);
}

/* ================= RENDER ================= */
function render(){

  tbody.innerHTML="";
  const bulanDipilih=Number(filterBulan.value)||1;

  masterProduk.forEach((mp,idx)=>{
    if(idx===0) return;

    const sku=String(mp[0]||"").trim();
    if(!sku || sku.toLowerCase()==="sku") return;

    const nama=mp[1]||"-";
    const kategoriProduk=getKategori(nama);

    if(kategoriAktif && kategoriProduk!==kategoriAktif) return;

    let stok=Number(mp[2])||0;
    let saldoAwal=stok, masuk=0, keluar=0;

    for(let b=1;b<=bulanDipilih;b++){

      let beli=0,jual=0;

      pembelian.forEach(p=>{
        const d=parseSheetDate(p[0]);
        if(!d||d.tahun!==TAHUN_AKTIF) return;
        if(String(p[5]).trim()!==sku) return;
        if(d.bulan===b) beli+=Number(p[4])||0;
      });

      penjualan.forEach(p=>{
        const d=parseSheetDate(p[0]);
        if(!d||d.tahun!==TAHUN_AKTIF) return;
        if(String(p[5]).trim()!==sku) return;
        if(d.bulan===b) jual+=Number(p[4])||0;
      });

      if(b===bulanDipilih){
        saldoAwal=stok;
        masuk=beli;
        keluar=jual;
      }

      stok+=beli-jual;
    }

    const forecast=hitungForecastPerProduk(sku,bulanDipilih);
    const restock=Math.max(forecast-stok,0);

    tbody.innerHTML+=`
<tr>
<td>${sku}</td>
<td>${nama}</td>
<td>${saldoAwal}</td>
<td>${masuk}</td>
<td>${keluar}</td>
<td><b>${stok}</b></td>
<td>${forecast}</td>
<td style="color:${restock>0?'red':'green'}">${restock}</td>
</tr>`;
  });

  applySearch();
}

/* ================= SEARCH ================= */
function applySearch(){
  const key=searchStock.value.toLowerCase();
  document.querySelectorAll("#stokBody tr").forEach(r=>{
    r.style.display=
      r.children[0].innerText.toLowerCase().includes(key) ||
      r.children[1].innerText.toLowerCase().includes(key)
      ? "" : "none";
  });
}

/* ================= PRINT SO ================= */
printBtn.addEventListener("click", function () {

  const bulanText = filterBulan.options[filterBulan.selectedIndex].text;
  const today = new Date();
  const tanggal = today.toLocaleDateString("id-ID", {
    day: "2-digit",
    month: "long",
    year: "numeric"
  });


  let printWindow = window.open("", "_blank");

  let html = `
  <html>
  <head>
  <title>Stok Opname</title>
  <style>
    @page { size: A4 portrait; margin: 20mm; }
    body {
      font-family: Arial, sans-serif;
      font-size: 12px;
      color: #000;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .logo {
      height: 60px;
    }
    .header-right {
      text-align: right;
      font-size: 12px;
    }
    h2 {
      margin: 5px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #000;
      padding: 6px;
      text-align: center;
    }
    th {
      background: #f2f2f2;
    }
    .footer {
      margin-top: 50px;
      display: flex;
      justify-content: space-between;
      text-align: center;
    }
    .ttd {
      width: 200px;
    }
  </style>
  </head>

  <body>

  <div class="header">
    <div class="header-left">
      <img src="logo.jpg" class="logo">
      <div>
        <h2>STOK OPNAME</h2>
        <div>Bulan: <b>${bulanText}</b></div>
        <div>Tanggal Cetak: ${tanggal}</div>
      </div>
    </div>

    <div class="header-right">
  <div><b>PIC:</b> ________________________</div>
  <div><b>Lokasi Gudang:</b> ________________________</div>
</div>

  <table>
    <tr>
      <th>SKU</th>
      <th>Produk</th>
      <th>Stok Sistem</th>
      <th>Stok Fisik</th>
      <th>Selisih</th>
      <th>Keterangan</th>
    </tr>
  `;

  document.querySelectorAll("#stokBody tr").forEach(row => {
    const cols = row.querySelectorAll("td");

    html += `
    <tr>
      <td>${cols[0].innerText}</td>
      <td style="text-align:left;padding-left:8px">${cols[1].innerText}</td>
      <td>${cols[5].innerText}</td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
    `;
  });

  html += `
  </table>

  <div class="footer">
    <div class="ttd">
      Mengetahui,<br><br><br><br>
      (__________________)
    </div>

    <div class="ttd">
      Diperiksa Oleh,<br><br><br><br>
      (__________________)
    </div>
  </div>

  </body>
  </html>
  `;

  printWindow.document.write(html);
  printWindow.document.close();
  printWindow.print();
});

/* ================= EVENT ================= */
filterBulan.addEventListener("change",()=>{render();});
searchStock.addEventListener("keyup",applySearch);

document.querySelectorAll(".btn-kategori").forEach(btn=>{
  btn.addEventListener("click",function(){
    document.querySelectorAll(".btn-kategori")
      .forEach(b=>b.classList.remove("active"));
    this.classList.add("active");
    kategoriAktif=this.dataset.kategori;
    render();
  });
});

</script>

</body>

</html>








