<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="logo.png">
    <title>Penjualan</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<!-- LOADING -->
<div id="loading">
  <img src="logo.jpg" alt="Loading">
  <p>Memuat data...</p>
</div>
<div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="logo">
            <img src="logo.jpg" alt="Logo">
            <h2>Inventory</h2>
        </div>

        <nav>
            <a href="index.html">Dashboard</a>
            <a href="penjualan.html" class="active">Penjualan</a>
            <a href="persediaan.html">Persediaan</a>
            <a href="forecasting.html">Forecasting</a>
        </nav>
    </aside>

    <!-- CONTENT -->
    <main class="content">
        <header>
            <!-- FILTER -->
<div class="filter-bar">
    <select id="filterOutlet">
        <option value="">Semua Outlet</option>
        
    </select>

    <select id="filterProduk">
        <option value="">Semua Produk</option>
        
    </select>
    <select id="filterBulan">
  <option value="">Semua Bulan</option>
  <option value="1">Januari</option>
  <option value="2">Februari</option>
  <option value="3">Maret</option>
  <option value="4">April</option>
  <option value="5">Mei</option>
  <option value="6">Juni</option>
  <option value="7">Juli</option>
  <option value="8">Agustus</option>
  <option value="9">September</option>
  <option value="10">Oktober</option>
  <option value="11">November</option>
  <option value="12">Desember</option>
</select>
</div>
            <h1>Penjualan</h1>
            <p>Daftar transaksi penjualan</p>
        </header>

        <div class="table-container">
            <table>
                <thead>
<tr>
    <th>Tanggal</th>
    <th>No PO</th>
    <th>Outlet</th>
</tr>
</thead>
                <tbody id="penjualanBody">
                   
                </tbody>
            </table>
        </div>
    </main>
</div>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbz17HxhRGYKJdb7Iq_W7mCYUG3_gQbJMUJ61k4URCb_c343VlxnykmbgaxM_V5QizNb/exec";

const tbody = document.getElementById("penjualanBody");
const filterOutlet = document.getElementById("filterOutlet");
const filterProduk = document.getElementById("filterProduk");
const filterBulan  = document.getElementById("filterBulan");
const loading = document.getElementById("loading");

let allPenjualan = []; // DATA ASLI

/* ================= FETCH DATA ================= */
fetch(API_URL)
  .then(res => res.json())
  .then(data => {
    allPenjualan = (data.penjualan || []).slice(1); // skip header

    isiDropdown();
    setDefaultBulan();
    applyFilter(); // render awal sesuai bulan

    hideLoading();
  })
  .catch(err => {
    console.error("API error:", err);
    hideLoading();
  });

/* ================= LOADING ================= */
function hideLoading() {
  loading.style.opacity = "0";
  loading.style.pointerEvents = "none";
  setTimeout(() => loading.style.display = "none", 300);
}

function showLoading() {
  loading.style.display = "flex";
  loading.style.opacity = "1";
  loading.style.pointerEvents = "auto";
}

/* ================= DROPDOWN ================= */
function isiDropdown() {
  const outletSet = new Set();
  const produkSet = new Set();

  allPenjualan.forEach(row => {
    outletSet.add(row[2]);
    produkSet.add(row[3]);
  });

  fillSelect(filterOutlet, outletSet);
  fillSelect(filterProduk, produkSet);
}

function fillSelect(select, setData) {
  [...setData].sort().forEach(val => {
    if (!val) return;
    const opt = document.createElement("option");
    opt.value = val;
    opt.textContent = val;
    select.appendChild(opt);
  });
}

/* ================= DEFAULT BULAN ================= */
function setDefaultBulan() {
  filterBulan.value = new Date().getMonth() + 1;
}

/* ================= RENDER TABLE ================= */
function renderTable(data) {
  tbody.innerHTML = "";
  const fragment = document.createDocumentFragment();

  // ðŸ”¹ GROUPING berdasarkan No PO
  const grouped = {};

  data.forEach(row => {
    const [tanggal, noPO, outlet, produk, qty, sku] = row;

    if (!grouped[noPO]) {
      grouped[noPO] = {
        tanggal,
        outlet,
        items: []
      };
    }

    grouped[noPO].items.push({ produk, qty, sku });
  });

  // ðŸ”¹ Render master + detail
  Object.keys(grouped).forEach(noPO => {
    const group = grouped[noPO];

    // === MASTER ROW ===
    const trMaster = document.createElement("tr");
    trMaster.classList.add("po-master");
    trMaster.innerHTML = `
      <td>${formatTanggal(group.tanggal)}</td>
      <td>${noPO}</td>
      <td>${group.outlet}</td>
    `;

    // === DETAIL ROW ===
    const trDetail = document.createElement("tr");
    trDetail.classList.add("po-detail");
    trDetail.innerHTML = `
      <td colspan="3">
        <table class="detail-table">
          <thead>
            <tr>
              <th>Produk</th>
              <th>Qty</th>
              <th>SKU</th>
            </tr>
          </thead>
          <tbody>
            ${group.items.map(item => `
              <tr>
                <td>${item.produk}</td>
                <td>${item.qty}</td>
                <td>${item.sku}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      </td>
    `;

    // toggle saat klik
    trMaster.addEventListener("click", () => {
      trDetail.classList.toggle("show");
    });

    fragment.appendChild(trMaster);
    fragment.appendChild(trDetail);
  });

  tbody.appendChild(fragment);
}

/* ================= FILTER DATA ================= */
function applyFilter() {
  showLoading();

  setTimeout(() => {
    const outletVal = filterOutlet.value;
    const produkVal = filterProduk.value;
    const bulanVal  = filterBulan.value;

    const filtered = allPenjualan.filter(row => {
      const tanggal = new Date(row[0]);
      const bulan   = tanggal.getMonth() + 1;

      const okOutlet = !outletVal || row[2] === outletVal;
      const okProduk = !produkVal || row[3] === produkVal;
      const okBulan  = !bulanVal  || bulan == bulanVal;

      return okOutlet && okProduk && okBulan;
    });

    renderTable(filtered);
    hideLoading();
  }, 200); // efek loading halus
}

/* ================= FORMAT TANGGAL ================= */
function formatTanggal(value) {
  const d = new Date(value);
  return `${String(d.getDate()).padStart(2,"0")}-${String(d.getMonth()+1).padStart(2,"0")}-${d.getFullYear()}`;
}

/* ================= EVENT ================= */
filterOutlet.addEventListener("change", applyFilter);
filterProduk.addEventListener("change", applyFilter);
filterBulan.addEventListener("change", applyFilter);
</script>
</body>

</html>

